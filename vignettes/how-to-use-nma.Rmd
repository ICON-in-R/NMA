---
title: "How to use NMA: Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How-to-use-NMA:-Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This document describes how to use the main functions of `NMA` to run a single network meta-analysis.

## Example

First load the required packages.

```{r setup, warning=FALSE, message=FALSE}
library(NMA)
library(dplyr)
library(purrr)
```

### Settings

Define the BUGS parameters for MCMC.
This is not necessary, but recommended, because there are default values for these.

```{r}
bugs_params <-
  list(
    PROG = "openBugs",  # which version of BUGS to use to run the MCMC
    N.BURNIN = 10,#00,  # number of steps to throw away
    N.SIMS = 150,#0,    # total number of simulations
    N.CHAINS = 2,       # number of chains
    N.THIN = 1,         # thinning rate
    PAUSE = TRUE)
```

Define the scenario we will use for the analysis.

```{r}
RANDOM <- FALSE             # is this a random effects model?
REFTX <- "ERL/GEF"          # reference treatment
is_bin <- TRUE              # include binary data?
is_med <- TRUE              # include median data?
label_name <- "BC_PFS_mFE"
endpoint <- "PFS"           # which end point, PFS, OS, ...?
analysis_type <- "BC"       # main data tag
```


### Read in datasets

The trials data consist of up to 3 separate data frames.
A main table, `subData`, and optional tables for median event time and binary data, `subDataMed` and `subDataBin` respectively.
Lets read in the each data set separately.
In another article we will show how to do this in one function call by including a Reference file in the data folder which contains the meta data of how to read in the study data.
If there is no binary or median data used in the NMA then the variables `subDataBin` and `subDataMed` are assigned `NA`.

```{r}
file_name <- paste0(here::here("raw_data"), "/survdata_", endpoint, "_")

subData <-
  read.csv(paste0(file_name, analysis_type, ".csv"),
           header = TRUE,
           as.is = TRUE)

subDataBin <-
  if (is_bin) {
    read.csv(paste0(file_name, "bin.csv"),
             header = TRUE,
             as.is = TRUE)
  } else {NA}

subDataMed <-
  if (is_med) {
    read.csv(paste0(file_name, "med.csv"),
             header = TRUE,
             as.is = TRUE) %>% 
      mutate(medR = floor(medR))
  } else {NA}
```


### Build model

Now we can create the NMA object to use in the modelling.
The workflow is to first create this separately to actually doing the fitting.
This then means that we can perform modified fits but we don't have to redo any of the preparatory work.

```{r}
nma_model <-
  new_NMA(subData = subData,
          subDataMed = subDataMed,
          subDataBin = subDataBin,
          bugs_params = bugs_params,
          is_random = RANDOM,
          refTx = REFTX ,
          effectParam = "beta",
          modelParams = "totresdev",
          label = label_name,
          endpoint = endpoint)

nma_model
```

We can view the network graph.

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=6}
##TODO: error when either bin or med missing

library(sna)
plotNetwork(nma_model)
```


### Run MCMC

The NMA MCMC function calls the appropriate BUGS model.

```{r}
nma_res <- NMA_run(nma_model)

nma_res

##TODO: errors

# diagnostics(nma_res)
# nma_outputs(nma_res)
```

### Reconfigure model

It is simple to modify an existing analysis without repeating the previous steps.
For example, we can run the NMA for a random effects rather than a fixed effects model version of the same model.

```{r}
nma_model2 <-
  NMA_update(nma_model,
             is_random = TRUE)

nma_res2 <- NMA_run(nma_model2,
                    output_dir = "RE output")

nma_res2

# diagnostics(nma_res2, save = TRUE)
# nma_outputs(nma_res2, save = TRUE)
```
